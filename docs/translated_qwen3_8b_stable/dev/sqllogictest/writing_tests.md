---
---
layout: docu
redirect_from:
- /dev/writing_tests
- /dev/writing_tests/
- /docs/dev/sqllogictest/writing_tests
title: 编写测试
---

## 开发与测试

任何新增的功能都必须有正确的测试，这些测试不仅要测试“正常流程”，还要测试边缘情况和功能的错误使用。在本节中，我们将介绍DuckDB测试的结构以及如何为DuckDB创建新的测试。

可以通过运行位于`test`文件夹中的`unittest`程序来运行这些测试。对于默认编译，该程序位于`build/release/test/unittest`（发布版）或`build/debug/test/unittest`（调试版）。

## 哲学

在测试DuckDB时，我们旨在通过SQL运行所有测试。我们尽量避免单独测试各个组件，因为这样会使这些组件在以后更难更改。因此，我们几乎所有测试都可以（并且应该）用纯SQL来表达。当然，也有某些例外情况，我们将在[Catch Tests]({% link docs/stable/dev/sqllogictest/catch.md %})中讨论。然而，在大多数情况下，您应该使用纯SQL编写测试。

## 框架

SQL测试应使用[sqllogictest框架]({% link docs/stable/dev/sqllogictest/intro.md %}）进行编写。

C++测试可以使用[Catch框架]({% link docs/stable/dev/sqllogictest/catch.md %}）进行编写。

## 客户端连接器测试

DuckDB还为各种客户端连接器提供了测试。这些测试通常使用相关的客户端语言编写，可以在`tools/*/tests`中找到。它们也作为文档，说明了从特定客户端应能执行哪些操作。

## 生成测试数据的函数

DuckDB内置了生成测试数据的函数。

### `test_all_types`函数

`test_all_types`表函数生成一个表，其列对应于类型（`BOOL`、`TINYINT`等）。该表有三行，分别表示每种类型的最小值、最大值和`NULL`值。

```sql
FROM test_all_types();
```

```text
┌─────────┬─────────┬──────────┬─────────────┬──────────────────────┬──────────────────────┬───┬──────────────────────┬──────────────────────┬──────────────────────┬──────────────────────┬──────────────────────┐
│  bool   │ tinyint │ smallint │     int     │        bigint        │       hugeint        │ … │        struct        │   struct_of_arrays   │   array_of_structs   │         map          │        union         │
│ boolean │  int8   │  int16   │    int32    │        int64         │        int128        │   │ struct(a integer, …  │ struct(a integer[]…  │ struct(a integer, …  │ map(varchar, varch…  │ union("name" varch…  │
├─────────┼─────────┼──────────┼─────────────┼──────────────────────┼──────────────────────┼───┼──────────────────────┼──────────────────────┼──────────────────────┼──────────────────────┼──────────────────────┤
│ false   │    -128 │   -32768 │ -2147483648 │ -9223372036854775808 │  -17014118346046923… │ … │ {'a': NULL, 'b': N…  │ {'a': NULL, 'b': N…  │ []                   │ {}                   │ Frank                │
│ true    │     127 │    32767 │  2147483647 │  9223372036854775807 │  170141183460469231… │ … │ {'a': 42, 'b': 🦆…   │ {'a': [42, 999, NU…  │ [{'a': NULL, 'b': …  │ {key1=🦆🦆🦆🦆🦆🦆…  │ 5                    │
│ NULL    │    NULL │     NULL │        NULL │                 NULL │                 NULL │ … │ NULL                 │ NULL                 │ NULL                 │ NULL                 │ NULL                 │
├─────────┴─────────┴──────────┴─────────────┴──────────────────────┴──────────────────────┴───┴──────────────────────┴──────────────────────┴──────────────────────┴──────────────────────┴──────────────────────┤
│ 3 rows                                                                                                                                                                                    44 columns (11 shown) │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### `test_vector_types`函数

`test_vector_types`表函数接受_n_个参数`col1`, ..., `coln`和一个可选的`BOOLEAN`参数`all_flat`。该函数生成一个包含_n_列的表`test_vector`, `test_vector2`, ..., `test_vectorn`。在每一行中，每个字段的值都符合其对应列的类型。

```sql
FROM test_vector_types(NULL::BIGINT);
```

```text
┌──────────────────────┐
│     test_vector      │
│        int64         │
├──────────────────────┤
│ -9223372036854775808 │
│  9223372036854775807 │
│                 NULL │
│         ...          │
└──────────────────────┘
```

```sql
FROM test_vector_types(NULL::ROW(i INTEGER, j VARCHAR, k DOUBLE), NULL::TIMESTAMP);
```

```text
┌──────────────────────────────────────────────────────────────────────┬──────────────────────────────┐
│                             test_vector                              │         test_vector2         │
│                struct(i integer, j varchar, k double)                │          timestamp           │
├──────────────────────────────────────────────────────────────────────┼──────────────────────────────┤
│ {'i': -2147483648, 'j': 🦆🦆🦆🦆🦆🦆, 'k': -1.7976931348623157e+308} │ 290309-12-22 (BC) 00:00:00   │
│ {'i': 2147483647, 'j': goo\0se, 'k': 1.7976931348623157e+308}        │ 294247-01-10 04:00:54.775806 │
│ {'i': NULL, 'j': NULL, 'k': NULL}                                    │ NULL                         │
│                                                  ...                                                │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

`test_vector_types`有一个可选参数`all_flat`，其类型为`BOOL`。这个参数只影响向量的内部表示形式。

```sql
FROM test_vector_types(NULL::ROW(i INTEGER, j VARCHAR, k DOUBLE), NULL::TIMESTAMP, all_flat = true);
-- 输出与上面相同，但内部表示形式不同
```